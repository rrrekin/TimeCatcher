#!/bin/sh

# Pre-commit hook to format markdown files and source code
# This script is shared in the repository and can be installed via: npm run install-hooks

# Get list of staged files
staged_md_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.md$' | grep -v node_modules || true)
staged_src_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js|vue|json|html|css|scss|yaml|yml)$' | grep -v node_modules || true)

# Check if any files need processing
if [ -z "$staged_md_files" ] && [ -z "$staged_src_files" ]; then
  # No files staged for formatting, exit successfully
  exit 0
fi

echo "ğŸ” Checking files for formatting issues..."

# Process markdown files if any are staged
if [ -n "$staged_md_files" ]; then
  # Check if markdownlint-cli2 is available
  if ! npm list markdownlint-cli2 >/dev/null 2>&1; then
    echo "âš ï¸  markdownlint-cli2 not found. Run 'npm install' to install dependencies."
    echo "âš ï¸  Skipping markdown formatting check."
  else
    # Run markdownlint-cli2 on staged files only
    echo "ğŸ“ Running markdownlint on staged files: $staged_md_files"

    # Create temporary file list for staged files
    temp_file=$(mktemp)
    echo "$staged_md_files" | tr ' ' '\n' > "$temp_file"

    # Run markdownlint with fix on the specific files
    if npx markdownlint-cli2 --config .markdownlint-cli2.jsonc $(cat "$temp_file"); then
      echo "âœ… Markdown formatting complete"
      
      # Add any fixed files back to the staging area
      for file in $staged_md_files; do
        if [ -f "$file" ]; then
          git add "$file"
        fi
      done
      
      # Clean up
      rm -f "$temp_file"
    else
      echo "âŒ Markdown formatting failed"
      echo "ğŸ’¡ Fix the issues above or run 'npm run format:md' to auto-fix what's possible"
      rm -f "$temp_file"
      exit 1
    fi
  fi
fi

# Process source files if any are staged
if [ -n "$staged_src_files" ]; then
  # Check if prettier is available
  if ! npm list prettier >/dev/null 2>&1; then
    echo "âš ï¸  Prettier not found. Run 'npm install' to install dependencies."
    echo "âš ï¸  Skipping code formatting check."
  else
    echo "ğŸ¨ Running Prettier on staged files: $staged_src_files"
    
    # Run prettier on staged files
    if echo "$staged_src_files" | xargs npx prettier --write; then
      echo "âœ… Code formatting complete"
      
      # Add any formatted files back to the staging area
      for file in $staged_src_files; do
        if [ -f "$file" ]; then
          git add "$file"
        fi
      done
    else
      echo "âŒ Code formatting failed"
      echo "ğŸ’¡ Fix the issues above or run 'npm run format' to format all files"
      exit 1
    fi
  fi
fi

echo "ğŸ‰ All formatting checks passed!"
exit 0